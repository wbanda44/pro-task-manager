<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProTask 2026 | Ultimate Master Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        :root {
            --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --col: #f1f5f9;
            --primary: #6366f1; --accent: #8b5cf6; --danger: #ef4444;
            --success: #22c55e; --warning: #eab308;
        }
        [data-theme="dark"] {
            --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --col: #334155;
        }

        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; transition: 0.3s; height: 100vh; overflow: hidden; }
        .main-layout { display: flex; gap: 20px; padding: 20px; max-width: 1600px; margin: auto; height: calc(100vh - 40px); }

        /* Sidebar Styling */
        .sidebar { width: 300px; background: var(--col); padding: 20px; border-radius: 20px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; }
        .user-stats-card { background: #1e293b; color: white; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .xp-bar-bg { background: #475569; height: 10px; border-radius: 5px; margin: 10px 0; overflow: hidden; }
        #xpBarFill { background: linear-gradient(90deg, #8b5cf6, #d946ef); height: 100%; width: 0%; transition: 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        
        #timer { font-size: 3rem; font-weight: 800; text-align: center; font-variant-numeric: tabular-nums; }
        .timer-finished { color: var(--danger); animation: shake 0.2s infinite; }

        /* Column & Board */
        .app-container { flex: 1; display: flex; flex-direction: column; gap: 20px; }
        .board { display: flex; gap: 20px; flex: 1; overflow-x: auto; padding-bottom: 10px; }
        .column { background: var(--col); border-radius: 16px; flex: 1; min-width: 320px; padding: 15px; display: flex; flex-direction: column; }
        .column-warning { border: 2px solid var(--danger); background: #fef2f2 !important; }
        .wip-limit-msg { color: var(--danger); font-size: 0.75rem; display: none; font-weight: bold; margin-bottom: 10px; }
        .column-warning .wip-limit-msg { display: block; }

        /* Task Cards */
        .task-list { flex: 1; overflow-y: auto; }
        .task-card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 12px; position: relative; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); cursor: grab; animation: popIn 0.3s ease-out; }
        .task-card.dragging { opacity: 0.5; }
        .high { border-left: 6px solid var(--danger); }
        .medium { border-left: 6px solid var(--warning); }
        .low { border-left: 6px solid var(--success); }
        
        .btn-delete { position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #94a3b8; }
        .btn-delete:hover { color: var(--danger); }

        /* Inputs */
        .glass-header { background: var(--card); padding: 20px; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; }
        input, select, textarea { padding: 10px; border-radius: 8px; border: 1px solid var(--col); background: var(--bg); color: var(--text); }
        input[type="text"] { flex: 1; }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-icon.listening { background: var(--danger); color: white; animation: pulse 1.5s infinite; }

        /* Animations */
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(5px); } }

        /* Leaderboard */
        .rival-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.05); font-size: 0.85rem; }
    </style>
</head>
<body>

<div class="main-layout">
    <aside class="sidebar">
        <div class="user-stats-card">
            <div style="color: var(--warning); font-weight: 800;">LVL <span id="userLevel">1</span></div>
            <div class="xp-bar-bg"><div id="xpBarFill"></div></div>
            <small><span id="currentXP">0</span> XP</small>
        </div>

        <div id="timer">25:00</div>
        <div style="display: flex; gap: 10px;">
            <button onclick="startTimer()" class="btn-primary" style="flex: 1;">Focus</button>
            <button onclick="resetTimer()" style="background: none; border: 1px solid #94a3b8; cursor: pointer; border-radius: 8px;">Reset</button>
        </div>

        <div class="leaderboard-card">
            <h4 style="margin: 0 0 10px 0;">üèÜ Daily Rivals</h4>
            <div id="rivalList"></div>
        </div>

        <div style="margin-top: auto;">
            <button onclick="toggleDarkMode()" style="width: 100%; padding: 10px; border-radius: 8px; cursor: pointer; background: var(--col); border: none; color: var(--text);">üåì Toggle Theme</button>
        </div>
    </aside>

    <main class="app-container">
        <header class="glass-header">
            <div class="input-row">
                <input type="text" id="taskInput" placeholder="New Task Name...">
                <button id="voiceBtn" class="btn-icon" style="border: none; border-radius: 8px; cursor: pointer; padding: 0 15px;">üé§</button>
                <select id="priorityInput">
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                </select>
                <input type="date" id="dateInput">
                <button onclick="addTask()" class="btn-primary">Add Task</button>
            </div>
            <textarea id="descInput" placeholder="Detailed notes..." style="width: 100%; margin-top: 10px; box-sizing: border-box;"></textarea>
        </header>

        <div class="board">
            <div class="column" id="todo">
                <h3>To Do <span id="todo-count" style="font-size: 0.8rem; opacity: 0.6;">0</span></h3>
                <div class="task-list"></div>
            </div>
            <div class="column" id="doing">
                <h3>Doing <span id="doing-count" style="font-size: 0.8rem; opacity: 0.6;">0</span></h3>
                <div class="wip-limit-msg">‚ö†Ô∏è WIP Limit Exceeded! Focus on finishing.</div>
                <div class="task-list"></div>
            </div>
            <div class="column" id="done">
                <h3>Done <span id="done-count" style="font-size: 0.8rem; opacity: 0.6;">0</span></h3>
                <div class="task-list"></div>
            </div>
        </div>
        <footer style="text-align: right; font-size: 0.7rem; color: #94a3b8;">Last saved: <span id="lastUpdated">--:--</span></footer>
    </main>
</div>

<script>
    // --- STATE ---
    let timerInterval, timeLeft = 25 * 60;
    const PRIORITY_POINTS = { high: 150, medium: 75, low: 30 };
    let userStats = JSON.parse(localStorage.getItem('userStats')) || { xp: 0, level: 1 };
    let rivals = [{ name: "FocusBot", xp: 1200 }, { name: "Procrastinator_X", xp: 850 }, { name: "EliteDev", xp: 2100 }];

    // --- INIT ---
    window.onload = () => {
        loadTasks();
        updateStatsUI();
        updateLeaderboard();
        updateColumnCounts();
    };

    // --- CORE FUNCTIONS ---
    function addTask() {
        const name = document.getElementById('taskInput').value;
        const prio = document.getElementById('priorityInput').value;
        const date = document.getElementById('dateInput').value;
        const desc = document.getElementById('descInput').value;
        if (!name) return;

        createTaskElement(name, 'todo', prio, date, desc);
        saveTasks();
        document.getElementById('taskInput').value = '';
        document.getElementById('descInput').value = '';
    }

    function createTaskElement(text, colId, priority, date, description) {
        const card = document.createElement('div');
        card.className = `task-card ${priority}`;
        card.draggable = true;
        card.dataset.priority = priority;
        card.dataset.desc = description;

        card.innerHTML = `
            <button class="btn-delete" onclick="this.parentElement.remove(); saveTasks();">&times;</button>
            <strong>${text}</strong><br>
            <small style="opacity: 0.7;">${date || ''}</small>
        `;

        card.ondragstart = () => card.classList.add('dragging');
        card.ondragend = () => { card.classList.remove('dragging'); saveTasks(); };
        document.querySelector(`#${colId} .task-list`).appendChild(card);
    }

    document.querySelectorAll('.column').forEach(col => {
        col.ondragover = e => e.preventDefault();
        col.ondrop = () => {
            const card = document.querySelector('.dragging');
            const sourceCol = card.parentElement.parentElement.id;
            col.querySelector('.task-list').appendChild(card);
            
            if (col.id === 'done' && sourceCol !== 'done') handleCompletion(card);
            saveTasks();
        };
    });

    function handleCompletion(card) {
        const p = card.dataset.priority;
        userStats.xp += PRIORITY_POINTS[p];
        userStats.level = Math.floor(0.1 * Math.sqrt(userStats.xp)) + 1;
        
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        speak(`Task complete. Plus ${PRIORITY_POINTS[p]} XP.`);
        
        rivals.forEach(r => r.xp += Math.floor(Math.random() * 50));
        updateStatsUI();
        updateLeaderboard();
    }

    // --- UI HELPERS ---
    function updateStatsUI() {
        document.getElementById('userLevel').innerText = userStats.level;
        document.getElementById('currentXP').innerText = userStats.xp;
        const nextLevelXP = Math.pow(userStats.level / 0.1, 2);
        const progress = (userStats.xp / nextLevelXP) * 100;
        document.getElementById('xpBarFill').style.width = progress + "%";
        localStorage.setItem('userStats', JSON.stringify(userStats));
    }

    function updateLeaderboard() {
        const list = document.getElementById('rivalList');
        let standings = [...rivals, { name: "You (Hero)", xp: userStats.xp, isUser: true }].sort((a,b) => b.xp - a.xp);
        list.innerHTML = standings.map(p => `
            <div class="rival-item" style="${p.isUser ? 'color: var(--warning); font-weight: bold;' : ''}">
                <span>${p.name}</span><span>${p.xp} XP</span>
            </div>`).join('');
    }

    function saveTasks() {
        const data = {};
        ['todo', 'doing', 'done'].forEach(id => {
            const cards = Array.from(document.querySelectorAll(`#${id} .task-card`));
            data[id] = cards.map(c => ({ text: c.querySelector('strong').innerText, prio: c.dataset.priority, date: c.querySelector('small').innerText, desc: c.dataset.desc }));
        });
        localStorage.setItem('kanbanData', JSON.stringify(data));
        updateColumnCounts();
        document.getElementById('lastUpdated').innerText = new Date().toLocaleTimeString();
    }

    function loadTasks() {
        const data = JSON.parse(localStorage.getItem('kanbanData'));
        if (!data) return;
        Object.keys(data).forEach(col => data[col].forEach(t => createTaskElement(t.text, col, t.prio, t.date, t.desc)));
    }

    function updateColumnCounts() {
        ['todo', 'doing', 'done'].forEach(id => {
            const count = document.querySelectorAll(`#${id} .task-card`).length;
            document.getElementById(`${id}-count`).innerText = count;
            if (id === 'doing') document.getElementById('doing').classList.toggle('column-warning', count > 5);
        });
    }

    // --- UTILS: TIMER, VOICE, THEME ---
    function startTimer() {
        if (timerInterval) return;
        timerInterval = setInterval(() => {
            timeLeft--;
            const m = Math.floor(timeLeft / 60), s = timeLeft % 60;
            document.getElementById('timer').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                speak("Focus session complete. Take a break.");
                document.getElementById('timer').classList.add('timer-finished');
            }
        }, 1000);
    }
    function resetTimer() { clearInterval(timerInterval); timerInterval = null; timeLeft = 25 * 60; document.getElementById('timer').innerText = "25:00"; document.getElementById('timer').classList.remove('timer-finished'); }

    function speak(text) { if ('speechSynthesis' in window) window.speechSynthesis.speak(new SpeechSynthesisUtterance(text)); }

    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    document.getElementById('voiceBtn').onclick = () => { recognition.start(); document.getElementById('voiceBtn').classList.add('listening'); };
    recognition.onresult = (e) => { document.getElementById('taskInput').value = e.results[0][0].transcript; document.getElementById('voiceBtn').classList.remove('listening'); };

    function toggleDarkMode() {
        const isDark = document.body.getAttribute('data-theme') === 'dark';
        isDark ? document.body.removeAttribute('data-theme') : document.body.setAttribute('data-theme', 'dark');
    }
</script>
</body>

</html>
